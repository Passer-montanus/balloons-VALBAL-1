/*
  Stanford Student Space Initiative
  Balloons | VALBAL | June 2017
  Davy Ragland | dragland@stanford.edu
  Aria Tedjarati | atedjara@stanford.edu

  File: GPS.h
  --------------------------
  Interface to Ublox NEO-M8Q GPS module.
*/

#ifndef GPS_H
#define GPS_H

#include <TinyGPS++.h>
#include <EEPROM.h>

class GPS {
public:
/**********************************  SETUP  ***********************************/
  GPS(uint8_t GPS_EnablePinNum, uint16_t GPS_BaudVal, uint8_t EEPROMAddressVal, uint16_t GPS_LockTime, uint16_t GPS_QuitTime) :
    GPS_ENABLE_PIN(GPS_EnablePinNum),
    GPS_BAUD(GPS_BaudVal),
    EEPROMAddress(EEPROMAddressVal),
    GPS_LOCK_TIME(GPS_LockTime),
    GPS_TIMEOUT_TIME(GPS_QuitTime) {
  }
  bool     init(bool shouldStartup);

/********************************  FUNCTIONS  *********************************/
  bool     restart();
  void     hotstart();
  void     shutdown();
  float    getLatitude();
  float    getLongitude();
  float    getAltitude();
  float    getSpeed();
  float    getCourse();
  uint8_t  getSats();
  void     smartDelay(uint32_t ms);
  void lowpower();

  int GPS_MODE = 1;

private:
/*********************************  HELPERS  **********************************/
  bool     setGPSMode(uint8_t* MSG, uint8_t len, uint16_t GPS_LOCK_TIME);
  void     sendUBX(uint8_t* MSG, uint8_t len);
  bool     getUBX_ACK(uint8_t* MSG);

/*********************************  OBJECTS  **********************************/
  uint8_t  GPS_ENABLE_PIN;
  uint16_t GPS_BAUD;
  uint8_t  EEPROMAddress;
  uint16_t GPS_LOCK_TIME;
  uint16_t GPS_TIMEOUT_TIME;
  TinyGPSPlus tinygps;

  uint8_t powerSave[48] = {
    0xB5, 0x62, 0x06, 0x11, 0x02, 0x00, 0x48, 0x01, 0x62, 0x12, 0xB5, 0x62, 0x05, 0x01, 0x02,
    0x00, 0x06, 0x11, 0x1F, 0x48, 0xB5, 0x62, 0x06, 0x11, 0x00, 0x00, 0x17, 0x4B, 0xB5, 0x62,
    0x06, 0x11, 0x02, 0x00, 0x48, 0x01, 0x62, 0x12, 0xB5, 0x62, 0x05, 0x01, 0x02, 0x00, 0x06,
    0x11, 0x1F, 0x48};
  uint8_t powerInterval[60] = {
    0xB5, 0x62, 0x06, 0x86, 0x08, 0x00, 0x00, 0x02, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA0,
    0xA4, 0xB5, 0x62, 0x05, 0x01, 0x02, 0x00, 0x06, 0x86, 0x94, 0xBD, 0xB5, 0x62, 0x06, 0x86,
    0x00, 0x00, 0x8C, 0xAA, 0xB5, 0x62, 0x06, 0x86, 0x08, 0x00, 0x00, 0x02, 0x0A, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xA0, 0xA4, 0xB5, 0x62, 0x05, 0x01, 0x02, 0x00, 0x06, 0x86, 0x94, 0xBD};
  uint8_t extendedPower[140] = {
    0xB5, 0x62, 0x06, 0x3B, 0x30, 0x00, 0x02, 0x06, 0x00, 0x00, 0x00, 0x00, 0x40, 0x01, 0x10,
    0x27, 0x00, 0x00, 0x10, 0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x2C, 0x01, 0x00, 0x00, 0x4F, 0xC1, 0x03, 0x00, 0x86, 0x02, 0x00, 0x00, 0xFE, 0x00, 0x00,
    0x00, 0x64, 0x40, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x93, 0xBA, 0xB5, 0x62, 0x05, 0x01,
    0x02, 0x00, 0x06, 0x3B, 0x49, 0x72, 0xB5, 0x62, 0x06, 0x3B, 0x00, 0x00, 0x41, 0xC9, 0xB5,
    0x62, 0x06, 0x3B, 0x30, 0x00, 0x02, 0x06, 0x00, 0x00, 0x00, 0x00, 0x40, 0x01, 0x10, 0x27,
    0x00, 0x00, 0x10, 0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2C,
    0x01, 0x00, 0x00, 0x4F, 0xC1, 0x03, 0x00, 0x86, 0x02, 0x00, 0x00, 0xFE, 0x00, 0x00, 0x00,
    0x64, 0x40, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x93, 0xBA, 0xB5, 0x62, 0x05, 0x01, 0x02,
    0x00, 0x06, 0x3B, 0x49, 0x72};
  uint8_t setTenthHz[150] = {
    0xB5, 0x62, 0x06, 0x08, 0x06, 0x00, 0x10, 0x27, 0x01, 0x00, 0x01, 0x00, 0x4D, 0xDD, 0xB5,
    0x62, 0x05, 0x01, 0x02, 0x00, 0x06, 0x08, 0x16, 0x3F, 0xB5, 0x62, 0x06, 0x08, 0x00, 0x00,
    0x0E, 0x30, 0xB5, 0x62, 0x06, 0x08, 0x06, 0x00, 0x10, 0x27, 0x01, 0x00, 0x01, 0x00, 0x4D,
    0xDD, 0xB5, 0x62, 0x05, 0x01, 0x02, 0x00, 0x06, 0x08, 0x16, 0x3F};
  uint8_t GNSSOff[60] = {
    0xB5, 0x62, 0x06, 0x57, 0x08, 0x00, 0x01, 0x00, 0x00, 0x00, 0x50, 0x4F, 0x54, 0x53, 0xAC,
    0x85, 0xB5, 0x62, 0x05, 0x01, 0x02, 0x00, 0x06, 0x57, 0x65, 0x8E, 0xB5, 0x62, 0x06, 0x57,
    0x00, 0x00, 0x5D, 0x1D, 0xB5, 0x62, 0x06, 0x57, 0x08, 0x00, 0x65, 0x08, 0x00, 0x00, 0x02,
    0x40, 0x00, 0x00, 0x14, 0x7D, 0xB5, 0x62, 0x05, 0x01, 0x02, 0x00, 0x06, 0x57, 0x65, 0x8E};
  uint8_t GNSSOn[60] = {
    0xB5, 0x62, 0x06, 0x57, 0x08, 0x00, 0x01, 0x00, 0x00, 0x00, 0x20, 0x4E, 0x55, 0x52, 0x7B,
    0xC3, 0xB5, 0x62, 0x06, 0x57, 0x00, 0x00, 0x5D, 0x1D, 0xB5, 0x62, 0x05, 0x01, 0x02, 0x00,
    0x06, 0x57, 0x65, 0x8E, 0xB5, 0x62, 0x06, 0x57, 0x08, 0x00, 0xE7, 0x1F, 0x00, 0x00, 0x00,
    0x40, 0x00, 0x00, 0xAB, 0x26, 0xB5, 0x62, 0x05, 0x01, 0x02, 0x00, 0x06, 0x57, 0x65, 0x8E};
  uint8_t GPSOnly[78] = {
    0xB5, 0x62, 0x06, 0x3E, 0x3C, 0x00, 0x00, 0x20, 0x14, 0x07, 0x00, 0x08, 0x10, 0x00, 0x01,
    0x00, 0x01, 0x01, 0x01, 0x01, 0x03, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x04, 0x08, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x03, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x01, 0x04, 0x00, 0x08,
    0x00, 0x00, 0x00, 0x00, 0x03, 0x05, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x05, 0x06, 0x08,
    0x0E, 0x00, 0x00, 0x00, 0x00, 0x01, 0x40, 0xB7, 0xB5, 0x62, 0x05, 0x01, 0x02, 0x00, 0x06,
    0x3E, 0x4C, 0x75};
  uint8_t GPSOnlyExtra[78] = {
    0xB5, 0x62, 0x06, 0x3E, 0x3C, 0x00, 0x00, 0x20, 0x10, 0x07, 0x00, 0x08, 0x10, 0x00, 0x01,
    0x00, 0x01, 0x01, 0x01, 0x01, 0x03, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x04, 0x08, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x03, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x01, 0x04, 0x00, 0x08,
    0x00, 0x00, 0x00, 0x00, 0x03, 0x05, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x05, 0x06, 0x08,
    0x0E, 0x00, 0x00, 0x00, 0x00, 0x01, 0x3C, 0xCF, 0xB5, 0x62, 0x05, 0x01, 0x02, 0x00, 0x06,
    0x3E, 0x4C, 0x75
  };
  uint8_t flightMode[44] = {
    0xB5, 0x62, 0x06, 0x24, 0x24, 0x00, 0xFF, 0xFF, 0x06, 0x03, 0x00, 0x00, 0x00, 0x00, 0x10,
    0x27, 0x00, 0x00, 0x05, 0x00, 0xFA, 0x00, 0xFA, 0x00, 0x64, 0x00, 0x2C, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x16, 0xDC};

//    uint8_t onoff[52] = {0xB5, 0x62, 0x06, 0x3B, 0x2C, 0x00, 0x01, 0x06, 0x00, 0x00, 0x0E, 0x90, 0x40, 0x01, 0x10, 0x27, 0x00, 0x00, 0x10, 0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x2C, 0x01, 0x00, 0x00, 0x4F, 0xC1, 0x03, 0x00, 0x87, 0x02, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x64, 0x40, 0x01, 0x00, 0x30, 0xEE};

uint8_t onoff[52] = {0xB5, 0x62, 0x06, 0x3B, 0x2C, 0x00, 0x01, 0x06, 0x00, 0x00, 0x0E, 0x90, 0x41, 0x01, 0x20, 0x4E, 0x00, 0x00, 0x10, 0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x2C, 0x01, 0x00, 0x00, 0x4F, 0xC1, 0x03, 0x00, 0x87, 0x02, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x64, 0x40, 0x01, 0x00, 0x68, 0xA9};

uint8_t gpsonly[52] = {0xB5, 0x62, 0x06, 0x3E, 0x2C, 0x00, 0x00, 0x00, 0x20, 0x05, 0x00, 0x08, 0x20, 0x00, 0x01, 0x00, 0x01, 0x01, 0x01, 0x01, 0x03, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x08, 0x10, 0x00, 0x00, 0x00, 0x01, 0x01, 0x05, 0x00, 0x03, 0x00, 0x00, 0x00, 0x01, 0x01, 0x06, 0x08, 0x0E, 0x00, 0x00, 0x00, 0x01, 0x01, 0x0C, 0x71};

  //uint8_t pms[10] = {0xB5, 0x62, 0x06, 0x11, 0x02, 0x00, 0x08, 0x01, 0x22, 0x92};
  uint8_t pms[16] = {0xB5, 0x62, 0x06, 0x86, 0x08, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x97, 0x6F};

};

#endif
